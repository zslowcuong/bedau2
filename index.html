<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Th·ªùi Kh√≥a Bi·ªÉu Hello Kitty</title>
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet">
    <style>
        :root {
            --hk-pink: #ffb7c5;
            --hk-dark-pink: #ff69b4;
            --hk-white: #fff0f5;
            --text-color: #5a3a4a;
            --bg-dots: #ffcdd2;
        }

        body {
            font-family: 'Itim', cursive;
            background-color: #ffe6f2;
            background-image: radial-gradient(var(--bg-dots) 15%, transparent 16%), radial-gradient(var(--bg-dots) 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: var(--text-color);
            cursor: url('https://cur.cursors-4u.net/others/oth-6/oth608.cur'), auto;
            overflow-x: hidden;
            overscroll-behavior: none; 
        }

        .container {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 25px;
            box-shadow: 0 10px 25px rgba(255, 105, 180, 0.3), 0 0 15px rgba(255, 183, 197, 0.5);
            border: 5px solid var(--hk-pink);
            max-width: 900px;
            width: 100%;
            position: relative;
            backdrop-filter: blur(5px);
            animation: popIn 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            transition: all 0.5s ease;
            margin-bottom: 80px; /* Ch·ª´a ch·ªó cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn */
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        h1 {
            text-align: center;
            color: var(--hk-dark-pink);
            font-size: 2.8em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 0px #fff;
            margin-top: 10px;
            background: linear-gradient(45deg, #ff69b4, #ffb7c5, #ff69b4);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 0px rgba(255,255,255,0.5);
            animation: gradientText 3s linear infinite;
        }

        @keyframes gradientText {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .stickers {
            text-align: center;
            font-size: 2em;
            margin-bottom: 15px;
            letter-spacing: 15px;
            cursor: default;
        }

        .stickers span:hover {
            display: inline-block;
            transform: scale(1.5) rotate(20deg);
            transition: transform 0.3s;
        }

        /* Responsive Table Wrapper */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 15px;
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 5px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 4px;
            margin-top: 10px;
            min-width: 650px;
        }

        th {
            background-color: var(--hk-pink);
            color: white;
            padding: 12px;
            border-radius: 10px;
            font-weight: normal;
            font-size: 1.2em;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        td {
            background-color: var(--hk-white);
            border: 2px solid #ffebf0;
            padding: 10px;
            text-align: center;
            border-radius: 10px;
            height: 50px;
            vertical-align: middle;
            transition: all 0.3s;
            font-size: 1.05em;
            position: relative;
            z-index: 1;
        }

        td:hover, td:active {
            background-color: #fff;
            transform: scale(1.02);
            border-color: var(--hk-dark-pink);
            box-shadow: 0 5px 15px rgba(255,105,180,0.3);
            z-index: 10;
        }

        /* √î ƒëang ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ edit */
        td:focus {
            outline: 3px dashed var(--hk-dark-pink);
            background-color: white;
            box-shadow: 0 0 15px var(--hk-pink);
            z-index: 20;
        }

        td[contenteditable="true"] {
            cursor: text;
        }
        
        td[contenteditable="true"]:empty::before {
            content: "Nh·∫≠p...";
            color: #e0c0c8;
            font-size: 0.8em;
            font-style: italic;
        }

        .session-title {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            font-weight: bold;
            background-color: var(--hk-dark-pink);
            color: white;
            width: 40px;
            font-size: 1.1em;
            border: 2px solid white;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        .subject {
            font-weight: bold;
            color: var(--hk-dark-pink);
            background-color: #fff0f6;
        }

        .note {
            display: block;
            font-size: 0.75em;
            color: #888;
            margin-top: 4px;
            font-style: italic;
            pointer-events: none;
        }

        /* --- STICKERS T√ôY CH·ªàNH --- */
        .custom-sticker {
            position: absolute;
            z-index: 20;
            max-width: 160px; 
            max-height: 160px;
            object-fit: contain;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.15));
            transition: transform 0.3s;
            display: block;
        }
        
        .custom-sticker:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .sticker-top-left {
            top: -30px;
            left: -20px;
            animation: float 4s ease-in-out infinite;
        }

        .sticker-top-right {
            top: -40px;
            right: -30px;
            animation: float 5s ease-in-out infinite reverse;
        }

        .sticker-bottom-left {
            bottom: -30px;
            left: -30px;
            animation: float 4.5s ease-in-out infinite 1s;
        }

        .sticker-bottom-right {
            bottom: -30px;
            right: -30px;
            animation: float 5.5s ease-in-out infinite 0.5s reverse;
        }

        @keyframes float {
            0% { transform: translateY(0px) rotate(-5deg); }
            50% { transform: translateY(-15px) rotate(0deg); }
            100% { transform: translateY(0px) rotate(-5deg); }
        }

        /* --- CONTROLS --- */
        .controls {
            margin-top: 30px;
            text-align: center;
            border-top: 2px dashed var(--hk-pink);
            padding-top: 20px;
            position: relative;
        }
        
        .edit-toolbar {
            text-align: center;
            margin-bottom: 15px;
            background: rgba(255, 240, 245, 0.9);
            padding: 10px;
            border-radius: 15px;
            border: 2px solid var(--hk-pink);
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .toolbar-label {
            color: var(--hk-dark-pink);
            font-weight: bold;
            margin-right: 5px;
        }

        .tool-btn {
            background: white;
            border: 2px solid var(--hk-pink);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Itim', cursive;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .tool-btn:hover {
            background: var(--hk-pink);
            color: white;
        }
        
        .tool-btn:active {
            transform: scale(0.95);
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .cute-input {
            border: 2px solid var(--hk-pink);
            border-radius: 20px;
            padding: 10px 15px;
            width: 100%;
            outline: none;
            color: var(--text-color);
            font-family: 'Itim', cursive;
            background: #fff0f5;
            transition: all 0.3s;
            box-sizing: border-box;
            font-size: 0.9em;
        }

        .cute-input:focus {
            border-color: var(--hk-dark-pink);
            background: white;
            box-shadow: 0 0 8px var(--hk-pink);
        }

        /* Fixed Bottom Controls */
        .fixed-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .fixed-btn {
            background: var(--hk-dark-pink);
            color: white;
            border: 2px solid white;
            padding: 12px 18px;
            border-radius: 50px;
            font-family: 'Itim', cursive;
            font-size: 1.1em;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .fixed-btn:hover {
            transform: scale(1.1);
            background: var(--hk-pink);
        }

        .fixed-btn.reset-btn {
            background: #ff6b6b;
        }

        /* Sparkle effect */
        .sparkle {
            position: absolute;
            pointer-events: none;
            width: 15px;
            height: 15px;
            animation: sparkle-anim 1s linear forwards;
            z-index: 100;
        }
        
        @keyframes sparkle-anim {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(180deg) translateY(20px); opacity: 0; }
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.8em; margin-top: 20px; }
            .container { padding: 15px 10px; margin: 0; border-radius: 15px; margin-bottom: 80px; }
            td, th { padding: 8px 5px; font-size: 0.95em; }
            /* Sticker tr√™n mobile c≈©ng to h∆°n 1 ch√∫t nh∆∞ng v·ª´a ph·∫£i */
            .custom-sticker { max-width: 90px; max-height: 90px; }
            .input-group { grid-template-columns: 1fr; }
            .stickers { font-size: 1.5em; letter-spacing: 10px; }
            .edit-toolbar { flex-direction: column; gap: 5px; }
            .fixed-controls { flex-direction: column; bottom: 10px; right: 10px; }
            .fixed-btn { font-size: 0.9em; padding: 10px 15px; }
        }

        /* Landscape / Fullscreen */
        @media screen and (orientation: landscape), :fullscreen {
            body {
                padding: 0;
                align-items: flex-start;
                background-attachment: fixed;
            }

            .container {
                max-width: none;
                width: 100%;
                min-height: 100vh;
                border-radius: 0;
                border: none;
                padding: 10px;
                display: flex;
                flex-direction: column;
                margin-bottom: 0;
            }

            h1 { font-size: 1.5em; margin: 5px 0; }
            .stickers, .controls, .edit-hint { display: none; } 
            
            /* Hi·ªán toolbar edit trong ch·∫ø ƒë·ªô xoay ngang ƒë·ªÉ ti·ªán s·ª≠a */
            .edit-toolbar { display: flex; order: -1; margin-bottom: 5px; }

            /* Gi·ªØ nguy√™n ƒë·ªô r√µ n√©t c·ªßa h√¨nh ·∫£nh, kh√¥ng l√†m m·ªù */
            .custom-sticker { 
                pointer-events: none; 
            }
            .sticker-top-left { top: -10px; left: -10px; }
            .sticker-top-right { top: -10px; right: -10px; }
            .sticker-bottom-left { bottom: -10px; left: -10px; }
            .sticker-bottom-right { bottom: -10px; right: -10px; }

            .table-wrapper {
                flex-grow: 1;
                width: 100%;
                overflow: auto;
            }
            
            table { width: 100%; margin-bottom: 60px; }
            .fixed-controls { opacity: 0.8; transform: scale(0.9); bottom: 10px; right: 10px; }
            .fixed-controls:hover { opacity: 1; }
        }
    </style>
</head>
<body>

<div class="container" id="main-container">
    <div id="default-bow" class="bow">üéÄ</div>
    <div id="default-face" class="kitty-face">üê±</div>
    
    <!-- 4 G√ìC H√åNH ·∫¢NH -->
    <img id="img-top-left" class="custom-sticker sticker-top-left" alt="G√≥c Tr√™n Tr√°i">
    <img id="img-top-right" class="custom-sticker sticker-top-right" alt="G√≥c Tr√™n Ph·∫£i">
    <img id="img-bottom-left" class="custom-sticker sticker-bottom-left" alt="G√≥c D∆∞·ªõi Tr√°i">
    <img id="img-bottom-right" class="custom-sticker sticker-bottom-right" alt="G√≥c D∆∞·ªõi Ph·∫£i">
    
    <h1>Th·ªùi Kh√≥a Bi·ªÉu üå∏</h1>
    <div class="stickers">
        <span>üç∞</span>
        <span>üå∏</span>
        <span>üç≠</span>
        <span>üéÄ</span>
    </div>
    
    <!-- Edit Toolbar -->
    <div class="edit-toolbar">
        <span class="toolbar-label">‚úèÔ∏è Ch·ªânh S·ªë Ti·∫øt (Ch·ªçn √¥ tr∆∞·ªõc):</span>
        <button class="tool-btn" onclick="mergeCells(1)">1 Ti·∫øt (H·ªßy g·ªôp)</button>
        <button class="tool-btn" onclick="mergeCells(2)">2 Ti·∫øt</button>
        <button class="tool-btn" onclick="mergeCells(3)">3 Ti·∫øt</button>
        <button class="tool-btn" onclick="mergeCells(4)">4 Ti·∫øt</button>
        <span id="save-status" style="font-size: 0.8em; color: green; margin-left: 10px;"></span>
    </div>

    <div class="table-wrapper">
        <table id="scheduleTable">
            <thead>
                <tr>
                    <th>Bu·ªïi</th>
                    <th>Ti·∫øt</th>
                    <th data-col-id="2">Th·ª© 2</th>
                    <th data-col-id="3">Th·ª© 3</th>
                    <th data-col-id="4">Th·ª© 4</th>
                    <th data-col-id="5">Th·ª© 5</th>
                    <th data-col-id="6">Th·ª© 6</th>
                    <th data-col-id="7">Th·ª© 7</th>
                    <th data-col-id="8">CN</th>
                </tr>
            </thead>
            <!-- Body s·∫Ω ƒë∆∞·ª£c load t·ª´ LocalStorage ho·∫∑c HTML m·∫∑c ƒë·ªãnh -->
            <tbody id="tableBody">
                <!-- N·ªôi dung m·∫∑c ƒë·ªãnh (s·∫Ω b·ªã ghi ƒë√® n·∫øu c√≥ d·ªØ li·ªáu l∆∞u) -->
                <tr>
                    <td rowspan="5" class="session-title">S√ÅNG ‚òÄÔ∏è</td>
                    <td>1</td>
                    <td data-col="2"></td> <td data-col="3"></td> <td data-col="4"></td> <td data-col="5"></td> <td data-col="6"></td> <td data-col="7"></td> <td data-col="8"></td>
                </tr>
                <tr>
                    <td>2</td>
                    <td data-col="2"></td> <td data-col="3"></td> <td data-col="4"></td> <td data-col="5"></td> <td data-col="6"></td> <td data-col="7"></td> <td data-col="8"></td>
                </tr>
                <tr>
                    <td>3</td>
                    <td data-col="2"></td> <td data-col="3"></td> <td data-col="4"></td> <td data-col="5"></td> <td data-col="6"></td> <td data-col="7"></td> <td data-col="8"></td>
                </tr>
                <tr>
                    <td>4</td>
                    <td data-col="2"></td> <td data-col="3"></td> <td data-col="4"></td> <td data-col="5"></td> <td data-col="6"></td> <td data-col="7"></td> <td data-col="8"></td>
                </tr>
                <tr>
                    <td>5</td>
                    <td data-col="2"></td> <td data-col="3"></td> <td data-col="4"></td> <td data-col="5"></td> <td data-col="6"></td> <td data-col="7"></td> <td data-col="8"></td>
                </tr>
                <tr>
                    <td rowspan="4" class="session-title" style="background-color: #ff9ec3;">CHI·ªÄU üåô</td>
                    <td>6</td>
                    <td data-col="2"></td> <td data-col="3"></td> <td data-col="4"></td> <td data-col="5"></td> <td data-col="6"></td> <td data-col="7"></td> <td data-col="8"></td>
                </tr>
                <tr>
                    <td>7</td>
                    <td data-col="2"></td> <td data-col="3"></td> <td data-col="4"></td> <td data-col="5"></td> <td data-col="6"></td> <td data-col="7"></td> <td data-col="8"></td>
                </tr>
                <tr>
                    <td>8</td>
                    <td data-col="2"></td> <td data-col="3"></td> <td data-col="4"></td> <td data-col="5"></td> <td data-col="6"></td> <td data-col="7"></td> <td data-col="8"></td>
                </tr>
                <tr>
                    <td>9</td>
                    <td data-col="2"></td> <td data-col="3"></td> <td data-col="4"></td> <td data-col="5"></td> <td data-col="6"></td> <td data-col="7"></td> <td data-col="8"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="controls">
        <p style="margin: 0 0 15px 0; color: var(--hk-dark-pink); font-size: 1.1em;">‚ú® Trang tr√≠ 4 g√≥c b·∫±ng link h√¨nh (T·ª± ƒë·ªông l∆∞u) ‚ú®</p>
        <div class="input-group">
            <input type="text" id="input-top-left" class="cute-input" placeholder="üîó G√≥c Tr√™n Tr√°i (M√®o)" oninput="updateImageAndSave('top-left', this.value)">
            <input type="text" id="input-top-right" class="cute-input" placeholder="üîó G√≥c Tr√™n Ph·∫£i (N∆°)" oninput="updateImageAndSave('top-right', this.value)">
            <input type="text" id="input-bottom-left" class="cute-input" placeholder="üîó G√≥c D∆∞·ªõi Tr√°i (B√°nh)" oninput="updateImageAndSave('bottom-left', this.value)">
            <input type="text" id="input-bottom-right" class="cute-input" placeholder="üîó G√≥c D∆∞·ªõi Ph·∫£i (K·∫πo)" oninput="updateImageAndSave('bottom-right', this.value)">
        </div>
    </div>
</div>

<div class="fixed-controls">
    <button class="fixed-btn reset-btn" onclick="resetAllData()">üóëÔ∏è Reset</button>
    <button id="fullscreen-btn" class="fixed-btn" onclick="toggleFullScreen()">‚õ∂ M·ªü r·ªông</button>
</div>

<script>
    // --- KH·ªûI T·∫†O & AUTO SAVE ---
    let lastSelectedCell = null;
    const STORAGE_KEY_TABLE = 'tkb_hk_table_html_v2';
    const STORAGE_KEY_IMGS = 'tkb_hk_images_v2';

    // ·∫¢nh m·∫∑c ƒë·ªãnh
    const defaultImages = {
        'top-left': 'https://sf-static.upanhlaylink.com/img/image_20251212eb8434ad94a2e2639558073d94b294ca.jpg',
        'top-right': 'https://sf-static.upanhlaylink.com/img/image_20251212c8a7ca755b7c25b16f408fc36abdf025.jpg',
        'bottom-left': 'https://sf-static.upanhlaylink.com/img/image_202512046c84562868689e59453a0cb4a1ee8b4d.jpg',
        'bottom-right': 'https://sf-static.upanhlaylink.com/img/image_20251204933dc9135c87a090a002478929debcd4.jpg'
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        setupCells(); // G√°n s·ª± ki·ªán cho c√°c √¥
    });

    function loadData() {
        // 1. Load ·∫¢nh
        const savedImgs = JSON.parse(localStorage.getItem(STORAGE_KEY_IMGS)) || defaultImages;
        for (const [pos, url] of Object.entries(savedImgs)) {
            document.getElementById(`input-${pos}`).value = url === defaultImages[pos] ? '' : url; // Ch·ªâ hi·ªán link n·∫øu kh√°c default
            updateImage(pos, url);
        }

        // 2. Load B·∫£ng
        const savedTable = localStorage.getItem(STORAGE_KEY_TABLE);
        if (savedTable) {
            document.getElementById('tableBody').innerHTML = savedTable;
            // T·ª∞ ƒê·ªòNG S·ª¨A L·ªñI C·∫§U TR√öC B·∫¢NG N·∫æU C√ì
            fixTableStructure();
        } else {
            // N·∫øu ch∆∞a c√≥ save, d√πng m·∫∑c ƒë·ªãnh
        }
    }

    // H√ÄM T·ª∞ ƒê·ªòNG S·ª¨A L·ªñI TI·∫æT 4, 5 NH·∫¢Y C·ªòT
    function fixTableStructure() {
        const rows = document.getElementById('tableBody').rows;
        let fixed = false;
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].cells;
            if (cells.length > 0) {
                const firstCell = cells[0];
                const isSessionTitle = firstCell.classList.contains('session-title');
                
                // Tr∆∞·ªùng h·ª£p 1: H√†ng kh√¥ng c√≥ ti√™u ƒë·ªÅ bu·ªïi (VD: Ti·∫øt 2, 3, 4, 5)
                // √î ƒë·∫ßu ti√™n ph·∫£i l√† √¥ Ti·∫øt (kh√¥ng c√≥ data-col). N·∫øu c√≥ data-col -> L·ªói
                if (!isSessionTitle && firstCell.hasAttribute('data-col')) {
                    // T√¨m √¥ Ti·∫øt (√¥ kh√¥ng c√≥ data-col) ƒëang b·ªã ƒë·∫©y ra sau
                    let periodCellIndex = -1;
                    for (let j = 0; j < cells.length; j++) {
                        if (!cells[j].hasAttribute('data-col') && !cells[j].classList.contains('session-title')) {
                            periodCellIndex = j;
                            break;
                        }
                    }
                    if (periodCellIndex > 0) {
                        rows[i].insertBefore(cells[periodCellIndex], firstCell);
                        fixed = true;
                    }
                } 
                // Tr∆∞·ªùng h·ª£p 2: H√†ng c√≥ ti√™u ƒë·ªÅ bu·ªïi (VD: S√°ng/Chi·ªÅu - Ti·∫øt 1, 6)
                else if (isSessionTitle && cells.length > 1) {
                    const secondCell = cells[1];
                    if (secondCell.hasAttribute('data-col')) {
                        let periodCellIndex = -1;
                        for (let j = 1; j < cells.length; j++) {
                            if (!cells[j].hasAttribute('data-col')) {
                                periodCellIndex = j;
                                break;
                            }
                        }
                        if (periodCellIndex > 1) {
                            rows[i].insertBefore(cells[periodCellIndex], secondCell);
                            fixed = true;
                        }
                    }
                }
            }
        }
        if (fixed) saveData(); // L∆∞u l·∫°i b·∫£n ƒë√£ s·ª≠a
    }

    function saveData() {
        const tableHtml = document.getElementById('tableBody').innerHTML;
        localStorage.setItem(STORAGE_KEY_TABLE, tableHtml);
        
        const imgs = {
            'top-left': document.getElementById('img-top-left').src,
            'top-right': document.getElementById('img-top-right').src,
            'bottom-left': document.getElementById('img-bottom-left').src,
            'bottom-right': document.getElementById('img-bottom-right').src
        };
        localStorage.setItem(STORAGE_KEY_IMGS, JSON.stringify(imgs));
        
        const status = document.getElementById('save-status');
        status.textContent = "ƒê√£ l∆∞u!";
        setTimeout(() => status.textContent = "", 2000);
    }

    function resetAllData() {
        if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·∫øt d·ªØ li·ªáu v√† quay v·ªÅ m·∫∑c ƒë·ªãnh kh√¥ng?")) {
            localStorage.removeItem(STORAGE_KEY_TABLE);
            localStorage.removeItem(STORAGE_KEY_IMGS);
            location.reload();
        }
    }

    // --- LOGIC B·∫¢NG & MERGE ---
    function setupCells() {
        // G√°n event listener cho to√†n b·ªô b·∫£ng (event delegation)
        const tbody = document.getElementById('tableBody');
        
        tbody.addEventListener('focusin', (e) => {
            const cell = e.target;
            if (cell.tagName === 'TD' && cell.hasAttribute('contenteditable')) {
                lastSelectedCell = cell;
            }
        });

        tbody.addEventListener('input', (e) => {
            const cell = e.target;
            if (cell.tagName === 'TD') {
                if (cell.textContent.trim() !== '') cell.classList.add('subject');
                else cell.classList.remove('subject');
                saveData(); // Save khi g√µ ch·ªØ
            }
        });
        
        // C√†i ƒë·∫∑t contenteditable cho c√°c √¥ ch∆∞a c√≥ (khi load l·∫°i trang c√≥ th·ªÉ m·∫•t listener, nh∆∞ng thu·ªôc t√≠nh HTML c√≤n)
        const rows = tbody.rows;
        for(let r=0; r<rows.length; r++) {
            const cells = rows[r].cells;
            for(let c=0; c<cells.length; c++) {
                const cell = cells[c];
                // B·ªè qua √¥ ti√™u ƒë·ªÅ (S√ÅNG/CHI·ªÄU/TI·∫æT)
                if(!cell.classList.contains('session-title') && isNaN(cell.textContent) && cell.textContent !== '') {
                    // Ki·ªÉm tra s∆° b·ªô, g√°n contenteditable cho c√°c √¥ d·ªØ li·ªáu
                }
                if(cell.dataset.col) {
                    cell.setAttribute('contenteditable', 'true');
                }
            }
        }
    }

    function mergeCells(rowSpanCount) {
        if (!lastSelectedCell) {
            alert("Vui l√≤ng ch·ªçn (b·∫•m v√†o) m·ªôt √¥ m√¥n h·ªçc tr∆∞·ªõc!");
            return;
        }
        
        const cell = lastSelectedCell;
        const currentRowIndex = cell.parentNode.rowIndex - 1; // -1 v√¨ thead
        const colId = cell.getAttribute('data-col'); // C·ªôt Th·ª© 2, 3, 4...
        
        if (!colId) {
            alert("Kh√¥ng th·ªÉ g·ªôp √¥ n√†y.");
            return;
        }

        // B∆∞·ªõc 1: Reset √¥ hi·ªán t·∫°i v·ªÅ 1 ti·∫øt (H·ªßy g·ªôp c≈© tr∆∞·ªõc khi g·ªôp m·ªõi)
        const currentSpan = cell.rowSpan;
        if (currentSpan > 1) {
            // Ch√®n l·∫°i c√°c √¥ ƒë√£ b·ªã x√≥a
            for (let i = 1; i < currentSpan; i++) {
                const targetRowIndex = currentRowIndex + i;
                const row = document.getElementById('tableBody').rows[targetRowIndex];
                if (row) {
                    // T·∫°o √¥ m·ªõi
                    const newCell = document.createElement('td');
                    newCell.setAttribute('contenteditable', 'true');
                    newCell.setAttribute('data-col', colId);
                    
                    // T√¨m v·ªã tr√≠ ch√®n: Duy·ªát row xem √¥ n√†o c√≥ data-col > colId th√¨ ch√®n tr∆∞·ªõc
                    // [FIX L·ªñI] N·∫øu √¥ kh√¥ng c√≥ data-col (√¥ Ti·∫øt), coi nh∆∞ col 0. N·∫øu c√≥, l·∫•y gi√° tr·ªã.
                    // Logic c≈© || 99 g√¢y l·ªói v√¨ 99 > 2 n√™n ch√®n tr∆∞·ªõc √¥ Ti·∫øt.
                    let inserted = false;
                    for(let c=0; c<row.cells.length; c++) {
                        const cellColAttr = row.cells[c].getAttribute('data-col');
                        // N·∫øu kh√¥ng c√≥ attr data-col, coi nh∆∞ l√† 0 (c·ªôt Ti·∫øt)
                        const nextCellCol = cellColAttr ? parseInt(cellColAttr) : 0; 
                        
                        if(nextCellCol > parseInt(colId)) {
                            row.insertBefore(newCell, row.cells[c]);
                            inserted = true;
                            break;
                        }
                    }
                    if(!inserted) row.appendChild(newCell);
                }
            }
            cell.rowSpan = 1;
        }

        // B∆∞·ªõc 2: N·∫øu y√™u c·∫ßu > 1 ti·∫øt, th·ª±c hi·ªán g·ªôp
        if (rowSpanCount > 1) {
            let canMerge = true;
            // Ki·ªÉm tra xem c√≥ ƒë·ªß h√†ng ƒë·ªÉ g·ªôp kh√¥ng
            const rows = document.getElementById('tableBody').rows;
            if (currentRowIndex + rowSpanCount > rows.length) {
                alert("Kh√¥ng ƒë·ªß s·ªë ti·∫øt b√™n d∆∞·ªõi ƒë·ªÉ g·ªôp!");
                return;
            }

            // X√≥a c√°c √¥ ·ªü h√†ng d∆∞·ªõi
            for (let i = 1; i < rowSpanCount; i++) {
                const targetRowIndex = currentRowIndex + i;
                const row = rows[targetRowIndex];
                // T√¨m √¥ c√≥ c√πng data-col
                let targetCell = null;
                for(let c=0; c<row.cells.length; c++) {
                    if(row.cells[c].getAttribute('data-col') === colId) {
                        targetCell = row.cells[c];
                        break;
                    }
                }

                if (targetCell) {
                    row.removeChild(targetCell);
                } else {
                    // N·∫øu kh√¥ng t√¨m th·∫•y √¥ (do ƒë√£ b·ªã g·ªôp b·ªüi √¥ kh√°c?), logic ph·ª©c t·∫°p
                    // ·ªû ƒë√¢y gi·∫£ s·ª≠ grid chu·∫©n
                }
            }
            cell.rowSpan = rowSpanCount;
        }
        
        saveData(); // L∆∞u c·∫•u tr√∫c b·∫£ng m·ªõi
    }

    // --- H√åNH ·∫¢NH ---
    function updateImageAndSave(pos, url) {
        // N·∫øu user x√≥a input, d√πng ·∫£nh default
        const finalUrl = url.trim() === '' ? defaultImages[pos] : url;
        updateImage(pos, finalUrl);
        saveData();
    }

    function updateImage(pos, url) {
        const img = document.getElementById(`img-${pos}`);
        if(img) {
            img.src = url;
            img.style.display = 'block';
            img.onerror = () => { img.style.display = 'none'; }; // ·∫®n n·∫øu link l·ªói
        }
    }

    // --- UTILS & EFFECTS ---
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().then(() => {
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(e => console.log(e));
                }
            }).catch(e => console.log(e));
            document.getElementById('fullscreen-btn').innerHTML = "‚úñ Thu nh·ªè";
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
            if (screen.orientation && screen.orientation.unlock) screen.orientation.unlock();
            document.getElementById('fullscreen-btn').innerHTML = "‚õ∂ M·ªü r·ªông";
        }
    }

    // Sparkle Effect
    let throttleTimer;
    document.addEventListener('mousemove', (e) => {
        if(!throttleTimer) {
            throttleTimer = setTimeout(() => {
                if(Math.random() > 0.5) createSparkle(e.pageX, e.pageY);
                throttleTimer = null;
            }, 50);
        }
    });
    
    document.addEventListener('touchmove', (e) => {
        if(Math.random() > 0.7) createSparkle(e.touches[0].pageX, e.touches[0].pageY);
    }, {passive: true});

    function createSparkle(x, y) {
        const sparkle = document.createElement('div');
        sparkle.classList.add('sparkle');
        const color = Math.random() > 0.5 ? '%23ff69b4' : '%23ffd700';
        sparkle.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}"><path d="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.967-7.417 3.967 1.481-8.279-6.064-5.828 8.332-1.151z"/></svg>')`;
        document.body.appendChild(sparkle);
        sparkle.style.left = (x + (Math.random()-0.5)*20) + 'px';
        sparkle.style.top = (y + (Math.random()-0.5)*20) + 'px';
        setTimeout(() => sparkle.remove(), 1000);
    }
</script>

</body>
</html>
